<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>can_eth_gw Gateway Module: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="CAN-eth-GW-mini.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">can_eth_gw Gateway Module
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">A bidirectional CAN to Ethernet Gateway (Kernel Module)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">can_eth_gw Gateway Module Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="top"></a></p>
<h1><a class="el" href="developer__doc_8md.html">developer_doc.md</a></h1>
<p>Developer dokumentation for the CAN Ethernet Gateway</p>
<p><a class="anchor" id="toc"></a> This file contains:</p>
<ol type="1">
<li><a href="#chap1">Overview / What is a CAN Ethernet Gateway</a><ol type="a">
<li><a href="#chap1-1">Ethernet followed by CAN</a></li>
<li><a href="#chap1-2">Ethernet followed by IP and TCP/UDP</a></li>
<li><a href="#chap1-3">Ethernet followed by IP, TCP/UDP and CAN</a></li>
</ol>
</li>
<li><a href="#chap1">CAN Ethernet Gateway concept</a><ol type="a">
<li><a href="#chap2-1">Netlink server</a></li>
<li><a href="#chap2-2">Virtual ethernet device</a></li>
<li><a href="#chap2-3">CAN - Ethernet Gateway</a></li>
<li><a href="#chap2-4">Netlink client</a></li>
</ol>
</li>
<li><a href="#chap3">Translating CAN and ethernet</a><ol type="a">
<li><a href="#chap3-1">Characteristics of CAN</a><ol type="i">
<li><a href="#chap3-1-1">CAN SFF and EFF</a></li>
<li><a href="#chap3-1-2">CAN FD</a></li>
<li><a href="#chap3-1-3">Length calculation</a></li>
</ol>
</li>
<li><a href="#chap3-2">Translation</a><ol type="i">
<li><a href="#chap3-2-1">Ethernet to CAN</a></li>
<li><a href="#chap3-2-2">Ethernet to CAN FD</a></li>
<li><a href="#chap3-2-3">CAN to ethernet</a></li>
<li><a href="#chap3-2-4">CAN FD to ethernet</a></li>
<li><a href="#chap3-2-5">Ethernet including complete CAN / CAN FD</a></li>
</ol>
</li>
<li><a href="#chap3-3">Special messages</a></li>
</ol>
</li>
<li><a href="#chap4">Routing</a><ol type="a">
<li><a href="#chap4-1">Routing lists</a></li>
</ol>
</li>
<li><a href="#chap5">Useful links</a></li>
<li><a href="#chap6">Copyright</a></li>
<li><a href="#chap7">References</a></li>
</ol>
<p><a class="anchor" id="chap1"></a></p>
<h2>1. Overview / What is a CAN Ethernet Gateway</h2>
<p>The CAN Ethernet Gateway converts a CAN (controller area network) signal into an ethernet signal. From a operation system perspective the gateway is disguised as an ethernet device by a virtual ethernet device. Due to missing equality of the frame structures there are some varying methods for translating the CAN frame. In the kernel module sources the types are represented with <code>enum ce_gw_type</code> (<code><a class="el" href="ce__gw__main_8h.html" title="Control Area Network - Ethernet - Gateway - Haeder.">ce_gw_main.h</a></code>) and in userspace with <code>enum gw_type</code> (<code>netlink.h</code>) _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap1-1"></a> </p>
<h3>1.1. Ethernet followed by CAN</h3>
<p>The first idea is to add a CAN header and the following payload directly after the ethernet frame. The CAN header always uses the structure implemented in the can.h (see 3.1) and not the original signal. This gateway type is named <code>TYPE_NET</code> (in kernel module with an prefix) in the sources, because CAN is here a network layer protocol. </p>
<pre class="fragment"> +____________________+
 |                    |
 |   MAC (Ethernet)   |
 +____________________+
 |  +______________+  |       +______________+
 |  |              |  |       |              |
 |  |  CAN header  |  |       |  CAN header  |
 |  +______________+&lt;-+------&gt;+______________+
 |  |              |  |       |              |
 |  |   payload    |  |       |   payload    |
 |  +______________+  |       +______________+
 +____________________+
</pre><p>This method is easy to implement but in return you need a special network on side of the ethernet signals. The network of the ethernet side must not be based on IP but on CAN. Otherwise the signal can't be interpreted. It is appropriate for CAN brigdes, where two or more CAN networks should be connected via a standart ethernet bridge. In principle this can also be done with the method described in 1.3 but method 1.1 is more effictive on a local computer.</p>
<p>The MAC address can be a broadcast address for keeping things easy but this will create a lot of traffic for the system. To keep the traffic low specific addresses are needed. Therefore it is necessary to define a mapping table, which definies one or more MAC address for one or more CAN identifier. The table is not implemented yet. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap1-2"></a> </p>
<h3>1.2 Ethernet followed by IP and TCP/UDP</h3>
<p>To avoid the need for a CAN network on the side of ethernet signals an IP and TCP/UDP header can be added after the ethernet header. They are followed by the payload of the CAN frame. The CAN header always uses the structure implemented in the can.h (see 3.1) and not the original signal. This gateway type is named <code>TYPE_ETH</code> (in kernel module with an prefix) in the sources. </p>
<pre class="fragment"> +______________________+      +______________________+
 |                      |      |                      |
 |    MAC (Ethernet)    |      |      CAN header      |
 +______________________+      +______________________+
 |  +________________+  |      |  +________________+  |
 |  |                |  |      |  |                |  |
 |  |   IP header    |  |      |  |   IP header    |  |
 |  +________________+  |      |  +________________+  |
 |  |                |  |      |  |                |  |
 |  | UDP/TCP header |&lt;-+------+-&gt;| UDP/TCP header |  |
 |  +________________+  |      |  +________________+  |
 |  |                |  |      |  |                |  |
 |  |    payload     |  |      |  |    payload     |  |
 |  +________________+  |      |  +________________+  |
 +______________________+      +______________________+
</pre><p>For this method a CAN frame already including IP and TCP/UDP header is needed. This special CAN frame makes it easier to implement but, of course, the gateway will only work if all CAN frames are organized in the given way. It is also necessary to use a CAN FD because standard and extended frame format CANs don't own enough specificed payload for the payload of IP header, TCP/UDP and payload itself. It can be used for networks using different layer two protocolls.</p>
<p>If ethernet just includes a payload without IP or TCP/UDP header it can still be translated into a CAN frame.</p>
<p>As there is no CAN header included in the ethernet frame anymore it is important to map the ID of the CAN header on the MAC address. But in comparison with the first approach the ethernet frames will be compatible with all networks using IP and TCP/UDP. These are not yet implemented. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap1-3"></a> </p>
<h3>1.3 Ethernet followed by IP, TCP/UDP and CAN</h3>
<p>If an ethernet frame is requested that is compatible with networks using IP and TCP/UDP and additionally using every CAN frame should be possible there is another option. The CAN header always uses the structure implemented in the can.h _<a href="#chap3-1">(see 3.1)</a>_ and not the original signal. This gateway type is named <code>TYPE_TCP</code> and <code>TYPE_UDP</code> (in kernel module with an prefix) in the sources. </p>
<pre class="fragment"> +______________________+
 |                      |
 |    MAC (Ethernet)    |
 +______________________+
 |                      |
 |      IP header       |
 +______________________+
 |                      |
 |    UDP/TCP header    |
 +______________________+
 |  +________________+  |       +________________+
 |  |                |  |       |                |
 |  |   CAN header   |  |       |   CAN header   |
 |  |________________|&lt;-+------&gt;+________________+
 |  |                |  |       |                |
 |  |    payload     |  |       |    payload     |
 |  +________________+  |       +________________+
 +______________________+
</pre><p>In this case any CAN frame is added into the payload of the TCP/UDP protokoll. The ID of the CAN frame is used to map an IP and also the port for TCP or UDP. Having the best functunallity the implementation of this stack is the hardest out of all three options. This method can be used for a CAN bridge over an IP network, e.g. internet. Another possibility is to use the gateway for sending a CAN frame to an application. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap2"></a></p>
<h2>2. CAN Ethernet Gateway concept</h2>
<p>The CAN Ethernet Gateway consists of three parts:</p>
<ul>
<li>netlink server</li>
<li>virtual ethernet device</li>
<li>CAN - Ethernet Gateway</li>
</ul>
<p>Additionally there is a netlink client in the userspace.</p>
<p>This graphic showes the structur of the CAN Ethernet Gateway:</p>
<div class="fragment"><div class="line">  _______________________________________________________</div>
<div class="line"> |                                                       |</div>
<div class="line"> |       CAN Ethernet Gateway Kernel Module (ce_gw)      |</div>
<div class="line"> |_______________________________________________________|</div>
<div class="line"> |                                                       |</div>
<div class="line"> |           Ethernet Frame    +----------------------+  |  CAN Frame</div>
<div class="line"> |           +-----o----------&gt;|CAN - Ethernet Gateway|&lt;-+-------o----+</div>
<div class="line"> |           |                 |     ce_gw_main.c     |  |            |</div>
<div class="line"> |           |                 +----------------------+  |            v</div>
<div class="line"> |           v                                           |       +----------+</div>
<div class="line"> | +--------------------+                                |       |CAN Device|</div>
<div class="line"> | |<span class="keyword">virtual</span> Ethernet dev|                                |       |  can.c   |</div>
<div class="line"> | |(<span class="stringliteral">&#39;cegw#&#39;</span> Interface) |         +---------------+      |       +----------+</div>
<div class="line"> | |    ce_gw_dev.c     |         |Netlink Server |      |            ^</div>
<div class="line"> | +--------------------+         |ce_gw_netlink.c|      |            |</div>
<div class="line"> |           ^                    +---------------+      |            v</div>
<div class="line"> |           |                            ^              |       +----------+</div>
<div class="line"> |___________|____________________________|______________|       |CAN Driver|</div>
<div class="line">             |                            o Netlink Frame        +----------+</div>
<div class="line">             v            Kernelspace     |                           ^</div>
<div class="line">           +----+       __________________|_____________              |</div>
<div class="line">           | OS |         Userspace       |                           v</div>
<div class="line">           +----+                         v                       +-------+</div>
<div class="line">                                 +------------------+             |CAN NIC|</div>
<div class="line">                                 |  Netlink Client  |             +-------+</div>
<div class="line">                                 |    netlink.c     |</div>
<div class="line">                                 |(can-eth-gw-utils)|</div>
<div class="line">                                 +------------------+</div>
<div class="line"></div>
<div class="line">Diagramm which shows the relation and packet transmission between</div>
<div class="line">the components of <span class="keyword">this</span> kernel module (ce_gw) and others of the OS.</div>
<div class="line">  _[UP](<span class="preprocessor">#top)_</span></div>
</div><!-- fragment --><p><a class="anchor" id="chap2-1"></a></p>
<h3>2.1 Netlink server</h3>
<p>The netlink server administrates the communication between kernel- and userspace. It enables a configuration of the gateway by the user. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap2-2"></a> </p>
<h3>2.2 Virtual ethernet device</h3>
<p>The virtual ethernet device theoretical disguises the CAN Ethernet Gateway as ethernet device. Therefore it is possible to use the gateway just like every other ethernet device without knowing the structure behind.</p>
<p><a class="anchor" id="chap2-3"></a> </p>
<h3>2.3 CAN - Ethernet Gateway</h3>
<p>The CAN - Ethernet Gateway is responsible for receiving CAN frames and translating them. Additionally it theoretical simulates an ethernet network so that it is possible to use every ethernet function on the translated CAN frame. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap2-4"></a> </p>
<h3>2.4 Netlink client</h3>
<p>The netlink client controls the gateway in the userspace. See application 'cegwctl' in package "can-eth-gw-utils": (<a href="https://github.com/can-eth-gw/can-eth-gw-utils" title="Sources on Github">Link</a>) _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3"></a></p>
<h2>3. Translating CAN and ethernet</h2>
<p><a class="anchor" id="chap3-1"></a> </p>
<h3>3.1 Characteristics of CAN</h3>
<p>While working with the CAN struct there are a few things to keep an eye on. First thing is that there are basicly three different CAN formats:</p>
<ul>
<li>CAN SFF (standard frame format)</li>
<li>CAN EFF (extended frame format)</li>
<li><p class="startli">CAN FD (fexible data)</p>
<p class="startli">_<a href="#top">UP</a>_</p>
</li>
</ul>
<p><a class="anchor" id="chap3-1-1"></a> </p>
<h4>3.1.1 CAN SFF and EFF</h4>
<p>CAN SFF and EFF use the same struct (can_frame). The difference between this two types can found in the header. While an SFF has eleven bit for the identifier plus three additional flags, EFF uses 29 bit for the identifier plus the same three flags. To detect which of this two types is used the CAN_EFF_FLAG needs to be checked. The original CAN signal has a different structure than the signal produced by the CAN struct.</p>
<p>Here is the original signal: </p>
<pre class="fragment">              1   1   1
   11 bit    bit bit bit  4 bit
+___________+___+___+___+______+
|           |   |   |   |      |
|identifier |RTR|EFF|res| DLC  | SFF header
+___________+___+___+___+______+

              1   1                      1   1   1
   11 bit    bit bit       18 bit       bit bit bit  4 bit
+___________+___+___+__________________+___+___+___+______+
|           |sub|   | extended         |   |   |   |      |
|identifier |RTR|EFF| identifier       |RTR|res|res| DLC  | EFF header
+___________+___+___+__________________+___+___+___+______+
</pre><p>The 13th bit decides whether the sent signal is SFF or EFF. (1 = EFF, 0 = SFF).</p>
<p>The struct can_frame changes the signal:</p>
<div class="fragment"><div class="line">                                 1   1   1    4     4</div>
<div class="line">   11 bit          18 bit       bit bit bit  bit   bit      3 byte</div>
<div class="line">+___________+__________________+___+___+___+_____+_____+________________+</div>
<div class="line">|           | extended         |   |   |   | DLC |     |                |</div>
<div class="line">|identifier | identifier       |ERR|RTR|EFF| pad | DLC |    padding     |</div>
<div class="line">+___________+__________________+___+___+___+_____+_____+________________+</div>
</div><!-- fragment --><p>To see if the message is a SFF or EFF the 32th bit needs to be checked. (1 = EFF, 0 = SFF). As both, SFF and EFF, use the same struct the 18 bit of extended identifier are set to 0 and ignored if the EFF flag is 0. Also there is an extended DLC field of 8 bit but only 4 bit are used. The first 4 bit are just padded. An additional flag for an error (ERR) is added which is not present in the original signal. There, an error is represented as a complete different signal. After the DLC an additional padding field of 3 byte is between the header and following data.</p>
<p>Both original SFF and EFF and the struct add a data field of eight byte. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-1-2"></a> </p>
<h4>3.1.2 CAN FD</h4>
<p>The CAN FD allows the use of a up to 64 byte data field. It also adds some additional flags and reserved fields. Therefore it is implemented in a new struct (canfd_frame). The structure of identifier, the ERR, RTR, EFF and the len field (same as DLC) is alike. After that part there are 24 bits of new FD specific fields, followed by 64 byte data. </p>
<pre class="fragment">                                 1   1   1
   11 bit          18 bit       bit bit bit  8 bit  8 bit  8 bit  8 bit
+___________+__________________+___+___+___+______+______+______+______+
|           | Extended         |   |   |   |      |      |      |      |
|identifier | identifier       |ERR|RTR|EFF| len  |flags | res0 | res1 |
+___________+__________________+___+___+___+______+______+______+______+
</pre><p>_<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-1-3"></a> </p>
<h4>3.1.3 Length calculation</h4>
<p>As the 64 byte data length should be represented by a only eight bit long len-field a calculation for the real length is needed. This is done by the can_dlc2len function included in can/dev.h. That function is also need for calculating the length of a can_frame. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-2"></a> </p>
<h3>3.2 Translation</h3>
<p>For sending the ethernet and CAN packages the sk buffer is used. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-2-1"></a> </p>
<h4>3.2.1 Ethernet to CAN</h4>
<p>As a CAN frame can only hold eight byte of data there is no space for including an IP or TCP/UDP header. Therefore we assume that the sk buffer includes only payload after the ethernet header as shown in the picture:</p>
<div class="fragment"><div class="line">mac header                                                          mac header</div>
<div class="line">data pointer--&gt;+----------------------+  +----------------------+&lt;--data pointer</div>
<div class="line">               |                      |  |                      |</div>
<div class="line">               | MAC (Ethernet) [14 B]|  |  CAN header [5 bit]  |</div>
<div class="line">     network--&gt;+----------------------+  +----------------------+&lt;--network</div>
<div class="line">     header    |  +----------------+  |  |  +----------------+  |   header</div>
<div class="line">               |  |                |  |  |  |                |  |</div>
<div class="line">               |  | payload [8 B]  |--+--+-&gt;| payload [8 B]  |  |</div>
<div class="line">               |  +----------------+  |  |  +----------------+  |</div>
<div class="line">   transport--&gt;+----------------------+  +----------------------+&lt;--transport</div>
<div class="line">   header                                                           header</div>
</div><!-- fragment --><p>The sk buffer has various pointers included. Here the mac header points correctly at the beginning of the ethernet or CAN header, whereas the network pointer dosen't point at the beginning of an IP header but at the start of the payload. Because there is no TCP/UDP header the transport pointer will point at the end of the data.</p>
<p>Even if the pointers of mac, network and transport header are set on the side of the CAN frame there is no guarentee that they will be used. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-2-2"></a> </p>
<h4>3.2.2 Ethernet to CAN FD</h4>
<p>When a ethernet frame is translated into a CAN FD it is possible to copy IP header as well as TCP/UDP header. It is just important that the total length of IP header, TCP/UDP header and payload is not more then 64 byte. Otherwise data will be lost.</p>
<div class="fragment"><div class="line">mac header                                                         mac header</div>
<div class="line">data pointer--&gt;+______________________+ +______________________+&lt;--data pointer</div>
<div class="line">               |                      | |                      |</div>
<div class="line">               | MAC (Ethernet) [14 B]| |  CAN FD header [8 B] |</div>
<div class="line">             __+______________________+ +______________________+__</div>
<div class="line">   network--/--+-&gt;+________________+  | |  +________________+&lt;-+--\--network</div>
<div class="line">   header   |  |  |                |  | |  |                |  |  |  header</div>
<div class="line">            |  |  |   IP header    |  | |  |   IP header    |  |  |</div>
<div class="line"> transport--+--+-&gt;+________________+  | |  +________________+&lt;-+--+--transport</div>
<div class="line"> header     /  |  |                |  | |  |                |  |  \  header</div>
<div class="line">    [64 B] &lt;   |  | UDP/TCP header |--+-+-&gt;| UDP/TCP header |  |   &gt; [64 B]</div>
<div class="line">            \  |  +________________+  | |  +________________+  |  /</div>
<div class="line">            |  |  |                |  | |  |                |  |  |</div>
<div class="line">            |  |  |     payload    |  | |  |     payload    |  |  |</div>
<div class="line">            |  |  +________________+  | |  +________________+  |  |</div>
<div class="line">            \__+______________________+ +______________________+__/</div>
</div><!-- fragment --><p>The mac and network header can be set correctly to the start of the CAN frame and IP header. There could only occour problems if the ethernet sk buffer is not including IP and TCP/UPD and just a short data field. Then the transport header will not be set at the beginning of UDP/TCP but at the end of the payload like in the ethernet to CAN translation.</p>
<p>Even if the pointers of mac, network and transport header are set on the side of the CAN frame there is no guarentee that they will be used. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-2-3"></a> </p>
<h4>3.2.3 CAN to ethernet</h4>
<p>To translate a CAN frame into an ethernet frame the payload will be copied at the end of the ethernet header. In this direction there is no danger to exceed the ethernet frame.</p>
<div class="fragment"><div class="line">                                                                    mac header</div>
<div class="line">data pointer--&gt;+----------------------+  +----------------------+&lt;--data pointer</div>
<div class="line">               |                      |  |                      |</div>
<div class="line">               |  CAN header [5 bit]  |  | MAC (Ethernet) [14 B]|</div>
<div class="line">               +----------------------+  +----------------------+&lt;--network</div>
<div class="line">               |  +----------------+  |  |  +----------------+  |   header</div>
<div class="line">               |  |                |  |  |  |                |  |</div>
<div class="line">               |  | payload [8 B]  |--+--+-&gt;| payload [8 B]  |  |</div>
<div class="line">               |  +----------------+  |  |  +----------------+  |</div>
<div class="line">               +----------------------+  +----------------------+&lt;--transport</div>
<div class="line">                                                                    header</div>
</div><!-- fragment --><p>However it can not be assumed that all pointers are set correctly in the CAN frame. Only the data pointer will point to the start of the CAN header. All other pointers: mac, network and transport header could point anywhere. Therefore it is neccessary to calculate the start and end of payload. Additional the transport header can still not be set correctly as there is no TCP/UDP header. Therefore it needs to be set at the and of the payload. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-2-4"></a> </p>
<h4>3.2.4 CAN FD to ethernet</h4>
<p>The translation of CAN FD to ethernet is quite similar to ethernet to CAN FD.</p>
<div class="fragment"><div class="line">                                                                   mac header</div>
<div class="line">data pointer--&gt;+______________________+ +______________________+&lt;--data pointer</div>
<div class="line">               |                      | |                      |</div>
<div class="line">               |  CAN FD header [8 B] | | MAC (Ethernet) [14 B]|</div>
<div class="line">             __+______________________+ +______________________+__</div>
<div class="line">            /  |  +________________+  | |  +________________+&lt;-+--\--network</div>
<div class="line">            |  |  |                |  | |  |                |  |  |  header</div>
<div class="line">            |  |  |   IP header    |  | |  |   IP header    |  |  |</div>
<div class="line">            |  |  +________________+  | |  +________________+&lt;-+--+--transport</div>
<div class="line">            /  |  |                |  | |  |                |  |  \  header</div>
<div class="line">    [64 B] &lt;   |  | UDP/TCP header |--+-+-&gt;| UDP/TCP header |  +   &gt; [64 B]</div>
<div class="line">            \  |  +________________+  | |  +________________+  |  /</div>
<div class="line">            |  |  |                |  | |  |                |  |  |</div>
<div class="line">            |  |  |     payload    |  | |  |     payload    |  |  |</div>
<div class="line">            |  |  +________________+  | |  +________________+  |  |</div>
<div class="line">            \__+______________________+ +______________________+__/</div>
</div><!-- fragment --><p>However again it can not be assumed that all pointers are set correctly in the CAN frame. Only the data pointer will point to the start of the CAN FD header. All other pointers: mac, network and transport header could point anywhere. Therefore it is neccessary to calculate the start and end of payload as well as start of IP and TCP/UDP header, if they are part of the CAN FD frame. If the CAN FD includes IP and TCP/UDP header both pointers can be set correctly as shown in the picture. Otherwise the transport pointer will be set to the end of the payload. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-2-5"></a> </p>
<h4>3.2.5 Ethernet including complete CAN / CAN FD</h4>
<p>If an ethernet frame includes a complete CAN or CAN FD frame the data after the ethernet header is just copied into a new sk buffer.</p>
<div class="fragment"><div class="line">mac header</div>
<div class="line">data pointer--&gt;+_______________________+</div>
<div class="line">               |                       |</div>
<div class="line">               | MAC (Ethernet) [14 B] |</div>
<div class="line">     network--&gt;+_______________________+</div>
<div class="line">     header    | +__________________+  |   +_________________+&lt;--data pointer</div>
<div class="line">               | | CAN/CAN FD header|  |   |CAN/CAN FD header|</div>
<div class="line">               | |     [5 B/8 B]    |  |   |    [5 B/8 B]    |</div>
<div class="line">               | +__________________+&lt;-+--&gt;+_________________+</div>
<div class="line">               | |      payload     |  |   |     payload     |</div>
<div class="line">               | |     [8 B/64 B]   |  |   |    [8 B/64 B]   |</div>
<div class="line">               | +__________________+  |   +_________________+</div>
<div class="line">   transport--&gt;+_______________________+</div>
<div class="line">   header</div>
</div><!-- fragment --><p>On the ethernet side mac, data and network pointer are set correctly. Only the transport pointer is pointing to the end of the payload. On CAN or CAN FD side only the data pointer is set. All other pointers can point anywhere. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap3-3"></a> </p>
<h3>3.3 Special messages</h3>
<p>On both sides, ethernet and CAN, there are some special messages that can not be translated directly. The ARP-requests could be managed by the gateway itself. The gateway could answer the requests by the mapping table described in 1.3. For the method of 1.1 and 1.2 new tables would be needed. When the CAN header is not included in the ethernet package the error bit of the CAN message will be lost. There is no way to translate it. Also a ping could be realized using the RTR bit (remote transmission bit) of the CAN header. Beside those messages described there are some other messages that can't be translated directly but are not relevant. These messages are not implemented yet. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap4"></a></p>
<h2>4. Routing</h2>
<p>In the CAN Ethernet Gateway there are two routs. One goes from the virtual ethernet device over the "CAN - ethernet gateway" to the CAN device. The other one routs excatly the other way round. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap4-1"></a> </p>
<h3>4.1 Routing lists</h3>
<div class="fragment"><div class="line">    +------------------+             /--------------------------------------\</div>
<div class="line">    |   &lt;&lt;Ethernet&gt;&gt;   |             |<a class="code" href="structce__gw__job.html">ce_gw_job</a> has ethernet as dst and CAN |</div>
<div class="line">    |<span class="keyword">struct </span>net_device |             |as source OR has ethernet as src and  |</div>
<div class="line">    +------------------+             |CAN as dst. hlist_node annotations are|</div>
<div class="line">+--&gt;|       ....       |             |members of the structs where the arrow|</div>
<div class="line">|   +------------------+             |points to. The hlist structs are not  |</div>
<div class="line">|           |                        |directly represented here and have    |</div>
<div class="line">|           |void *priv              |been simplyfied.                      |</div>
<div class="line">|           |                        \--------------------------------------/</div>
<div class="line">|           v</div>
<div class="line">|   +---------------------+        <span class="keyword">struct </span>hlist_head ce_gw_job_list</div>
<div class="line">|   |struct <a class="code" href="structce__gw__job__info.html" title="The private Field of ether struct net_device with pointer to its job.">ce_gw_job_info</a>|                       |</div>
<div class="line">|   +---------------------+                       |</div>
<div class="line">|   |                     |    struct hlist_node  |</div>
<div class="line">|   +---------------------+        list         \ |</div>
<div class="line">|                 | | struct                     \|</div>
<div class="line">|         struct  | |hlist_head                   |     +------------------+</div>
<div class="line">|       hlist_head| | job_src                     |     |     &lt;&lt;CAN&gt;&gt;      |</div>
<div class="line">|         job_dst | |                             |     |struct net_device |</div>
<div class="line">|                 | |\                            |     +------------------+</div>
<div class="line">|                 | | struct hlist_node           |     |       ....       |</div>
<div class="line">|                 | |/   list_dev                 |     +------------------+</div>
<div class="line">|                 | /                             |               ^</div>
<div class="line">|                 |/|                             |0...*          |</div>
<div class="line">| <span class="keyword">struct          </span>| |       0...*                 v               | <span class="keyword">struct</span></div>
<div class="line">|net_device       | +---------&gt;+----------------------+           |net_device</div>
<div class="line">| *dev            +-----------&gt;|  <span class="keyword">struct </span><a class="code" href="structce__gw__job.html">ce_gw_job</a>    |           | *<a class="code" href="structce__gw__job.html#abf690dbcccc005ba94a1ce16864ccdc9">dev</a></div>
<div class="line">|                        0...* +----------------------+           |</div>
<div class="line">|        +-------------+       |<span class="keyword">struct </span>rcu_head rcu   |      +-------------+</div>
<div class="line">|        |   union     |       |u32 id                |      |   union     |</div>
<div class="line">+--------+-------------+       |enum <a class="code" href="ce__gw__main_8h.html#ae9169581523a63d249884c335b34f066" title="Type of the Gateway.">ce_gw_type</a> type  |      +-------------+</div>
<div class="line">         |             |&lt;&gt;-----|u32 flags             |----&lt;&gt;|             |</div>
<div class="line">         +-------------+  dst/ |u32 handled_frames    | src/ +-------------+</div>
<div class="line">                          src  |u32 dropped_frames    | dst</div>
<div class="line">                               |union { <span class="keyword">struct </span>can_   |</div>
<div class="line">                               |filter can_rcv_filter}|</div>
<div class="line">                               +----------------------+</div>
</div><!-- fragment --><p>All routes between CAN and ethernet are saved in the ce_gw_job_list, which is part of the <a class="el" href="structce__gw__job.html">ce_gw_job</a> struct.</p>
<p>Additionally the virtual ethernet device manages two lists:</p>
<ul>
<li>job_dst</li>
<li>job_src</li>
</ul>
<p>Every ethernet device has it's own 2 lists.</p>
<p>In job_dst all entrys point to a instance of <a class="el" href="structce__gw__job.html">ce_gw_job</a>. Here the saved source must be identical to the ethernet device, that owns the list.</p>
<p>Job_src works in the same way. It lists all instances of <a class="el" href="structce__gw__job.html">ce_gw_job</a>, that reference the ethernet device as source. _<a href="#top">UP</a>_</p>
<p><a class="anchor" id="chap5"></a></p>
<h2>5. Useful links</h2>
<ul>
<li>bosch CAN documentation: <a href="http://www.bosch-semiconductors.de/media/pdf_1/
canliteratur/can_fd_spec.pdf">http://www.bosch-semiconductors.de/media/pdf_1/ canliteratur/can_fd_spec.pdf</a></li>
<li>socket can: <a href="https://gitorious.org/
linux-can">https://gitorious.org/linux-can</a></li>
</ul>
<p><a class="anchor" id="chap6"></a></p>
<h2>6. Copyright</h2>
<p>(C) Copyright 2013 Fabian Raab, Stefan Smarzly</p>
<p>This file is part of CAN-Eth-GW.</p>
<p>CAN-Eth-GW is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>CAN-Eth-GW is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with CAN-Eth-GW. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>
<p><a class="anchor" id="chap7"></a></p>
<h2>7. References</h2>
<p><b>Sources:</b> <a href="https://github.com/can-eth-gw/can_eth_gw/" title="Sources">https://github.com/can-eth-gw/can_eth_gw/</a></p>
<p><b>Homepage:</b> <a href="http://can-eth-gw.github.io/" title="Homepage">http://can-eth-gw.github.io/</a></p>
<p><b>Authors:</b></p>
<ul>
<li>Ann Katrin Gibtner</li>
<li>Fabian Raab _<a href="#" onclick="location.href='mai'+'lto:'+'fab'+'ia'+'n.r'+'aa'+'b@t'+'um'+'.de'; return false;">fabia<span style="display: none;">.nosp@m.</span>n.ra<span style="display: none;">.nosp@m.</span>ab@tu<span style="display: none;">.nosp@m.</span>m.de</a>_</li>
<li>Stefan Smarzly _<a href="#" onclick="location.href='mai'+'lto:'+'ste'+'fa'+'n.s'+'ma'+'rzl'+'y@'+'in.'+'tu'+'m.d'+'e'; return false;">stefa<span style="display: none;">.nosp@m.</span>n.sm<span style="display: none;">.nosp@m.</span>arzly<span style="display: none;">.nosp@m.</span>@in.<span style="display: none;">.nosp@m.</span>tum.d<span style="display: none;">.nosp@m.</span>e</a>_</li>
</ul>
<p><b>Date:</b> 15. July 2013 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jul 15 2013 22:27:45 for can_eth_gw Gateway Module by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
